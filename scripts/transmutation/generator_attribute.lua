local buffs = {}

-- =============================================================================
--  TESTING FLAG 
-- =============================================================================
-- If true, all reactions generated by this file will have no cost.
-- Set to false for normal (costly) recipes.
local MAKE_REACTIONS_FREE_FOR_TESTING = true
-- =============================================================================

-- =============================================================================
-- This map defines the different tiers.
-- This replaces the NODE_MAP from the weapon generator.
-- =============================================================================
local LEVEL_MAP = {
    { 
        key = "PRIMARY", 
        token = "PRIMARY", 
        name = "Primary",
        syn_class = "PRIMARY", 
        reagent_suffix = "_PRIMARY" 
    },
    { 
        key = "SECONDARY", 
        token = "SECONDARY", 
        name = "Secondary",
        syn_class = "SECONDARY",
        reagent_suffix = "_SECONDARY"
    },
    { 
        key = "TERTIARY", 
        token = "TERTIARY", 
        name = "Tertiary",
        syn_class = "TERTIARY",
        reagent_suffix = "_TERTIARY"
    },
    { 
        key = "QUATERNARY", 
        token = "QUATERNARY", 
        name = "Quaternary",
        syn_class = "QUATERNARY",
        reagent_suffix = "_QUATERNARY"
    }
    -- You can add a fifth level here (e.g., "QUINARY") and
    -- the generator will automatically create all its raws
    -- as long as you provide the data in the config file.
}

-- =============================================================================
-- ### RAW BUILDER FUNCTIONS ###
-- =============================================================================

-- 1. Builds the Payload Interaction (from interaction_zinteraction_attribute.txt)
local function build_payload_interaction(config, level)
    local lines = {}
    local interaction_id = string.format("%s_%s", config.PAYLOAD_PREFIX, level.token)
    
    table.insert(lines, string.format("[INTERACTION:%s]", interaction_id))
    add_generated_info(lines)
    
    local static_raws = [[
    [I_TARGET:A:CREATURE]
        [IT_LOCATION:CONTEXT_CREATURE]
        [IT_CANNOT_TARGET_IF_ALREADY_AFFECTED]
        [IT_MANUAL_INPUT:target]
    [I_EFFECT:ADD_SYNDROME]
        [IE_TARGET:A]
        [IE_IMMEDIATE]
        [SYNDROME]
]]
    table_merge(lines, split_to_lines({}, static_raws))

    -- Add the syndrome name from config
    table.insert(lines, string.format("            [SYN_NAME:%s]", config.BUFF_SYNDROME_NAME))

    -- === FULFILLS NEW REQUIREMENT ===
    -- Add the dynamic syndrome effects directly from the config
    local effects = config.PAYLOAD_EFFECTS[level.key]
    if effects and #effects > 0 then
        for _, effect_line in ipairs(effects) do
            -- Insert the raw string from the config table
            table.insert(lines, string.format("            %s", effect_line))
        end
    else
        log(string.format("WARNING: No PAYLOAD_EFFECTS defined for %s - %s", config.BUFF_NAME, level.key))
    end
    
    return lines
end

-- 2. Builds the Inorganic Tablet (from inorganic_tablet_body_attribute.txt)
local function build_inorganic_tablet(config, level)
    local lines = {}
    local inorganic_id = string.format("%s_%s_PROGRAM", config.ID_PREFIX, level.token)
    local tablet_name_adj = string.format("%s %s core implant", level.name:lower(), config.BUFF_NOUN)
    local meat_name = string.format("%s %s enhancement tablet", level.name:lower(), config.BUFF_NOUN)
    local ability_name = string.format("%s- %s", config.ABILITY_ADV_NAME, level.name)
    
    -- Get the correct verb for this level
    local verb = config.ABILITY_VERBS[level.key] or "perform a generic buff:performs a generic buff:NA"

    table.insert(lines, string.format("[INORGANIC:%s]", inorganic_id))
    add_generated_info(lines)

    -- MODIFIED: Removed [CDI:BP_REQUIRED:%s]
    local rest_of_raw = string.format([[
    [USE_MATERIAL_TEMPLATE:MUSCLE_TABLET_TEMPLATE][MEAT][SPECIAL]
    [STATE_NAME_ADJ:ALL_SOLID:%s][DISPLAY_COLOR:%s][TILE:%s]
    [MELTING_POINT:12070]
    [SOLID_DENSITY:400]
    [MEAT_NAME:NONE:%s:%s]
    [SYNDROME]
        [SYN_INGESTED]
        [CE_DISPLAY_NAME:NAME:transmuter:transmuters:transmuter:START:0]
        [SYN_CLASS:%s][SYN_IMMUNE_CLASS:%s]
        [SYN_CLASS:%s][SYN_IMMUNE_CLASS:%s]
    [CE_CAN_DO_INTERACTION:PROB:100:START:0:ABRUPT]
        [CDI:ADV_NAME:%s]
        [CDI:TARGET:A:SELF_ONLY]
        [CDI:INTERACTION:%s_%s]
        [CDI:USAGE_HINT:DEFEND]
        [CDI:MAX_TARGET_NUMBER:A:1]
        [CDI:VERB:%s]
        [CDI:WAIT_PERIOD:%d]
]],
        tablet_name_adj, config.TABLET_COLOR, config.TABLET_TILE, -- STATE_NAME_ADJ
        meat_name, meat_name, -- MEAT_NAME
        config.ID_PREFIX, config.ID_PREFIX, -- SYN_CLASS (e.g., ENHANCEAGILITY)
        level.syn_class, level.syn_class, -- SYN_CLASS (e.g., PRIMARY)
        ability_name, -- CDI:ADV_NAME
        config.PAYLOAD_PREFIX, level.token, -- CDI:INTERACTION (e.g., AGILITYENHANCE_PRIMARY)
        -- MODIFIED: Removed config.ABILITY_BP_REQUIRED argument
        verb, -- CDI:VERB
        config.ABILITY_WAIT_PERIOD -- CDI:WAIT_PERIOD
    )
    
    table_merge(lines, split_to_lines({}, rest_of_raw))
    return lines
end

-- 3. Builds the Secret Interaction (from interaction_tech_attribute_*.txt)
local function build_secret_interaction(config, level)
    local lines = {}
    local interaction_id = string.format("%s_%s_SECRET", config.SECRET_PREFIX, level.token)
    local hist_string = string.format("who gained %s Body Enhancement- %s from them", level.name, config.BUFF_NAME)
    local secret_name = string.format("the %s Body Enhancement- %s", level.name, config.BUFF_NAME)
    local arena_name = string.format("%s %s", level.name, config.BUFF_NAME)
    local ability_name = string.format("%s- %s", config.ABILITY_ADV_NAME, level.name)

    -- Get the correct verb for this level
    local verb = config.ABILITY_VERBS[level.key] or "perform a generic buff:performs a generic buff:NA"
    
    table.insert(lines, string.format("[INTERACTION:%s]", interaction_id))
    add_generated_info(lines)

    -- MODIFIED: Removed [CDI:BP_REQUIRED:%s]
    local rest_of_raw = string.format([[
    [I_SOURCE:DEITY]
        [IS_USAGE_HINT:MAJOR_CURSE]
        [IS_HIST_STRING_1: the infodeity was challenged in the Datasphere by ]
        [IS_HIST_STRING_2: %s]
    [I_SOURCE:SECRET]
        [IS_NAME:%s]
        [IS_SECRET_GOAL:IMMORTALITY]
        [IS_SECRET:SUPERNATURAL_LEARNING_POSSIBLE]
        [IS_SECRET:MUNDANE_RECORDING_POSSIBLE:BOOK_INSTRUCTION:SECRET_CORE]
    [I_SOURCE:INGESTION]
        [IS_HIST_STRING_1: consumed the nanite-infused blood of ]
        [IS_HIST_STRING_2: and gained their power]
    [I_TARGET:A:CREATURE]
        [IT_LOCATION:CONTEXT_CREATURE]
        [IT_REQUIRES:CAN_LEARN]
        [IT_REQUIRES:CAN_SPEAK]
        [IT_CANNOT_HAVE_SYNDROME_CLASS:%s]
        [IT_CANNOT_HAVE_SYNDROME_CLASS:%s]
    [I_EFFECT:ADD_SYNDROME]
        [IE_TARGET:A]
        [IE_IMMEDIATE]
        [IE_ARENA_NAME:%s]
        [SYNDROME]
            [SYN_CLASS:%s][SYN_CLASS:%s]
            [CE_DISPLAY_NAME:NAME:transmuter:transmuters:transmuter:START:0]
            [CE_BODY_MAT_INTERACTION:MAT_TOKEN:RESERVED_BLOOD:START:0]
                [CE:INTERACTION:%s]
                [CE:SYNDROME_TAG:SYN_INJECTED]
            [CE_CAN_DO_INTERACTION:PROB:100:START:0:ABRUPT]
                [CDI:ADV_NAME:%s]
                [CDI:TARGET:A:SELF_ONLY]
                [CDI:INTERACTION:%s_%s]
                [CDI:USAGE_HINT:DEFEND]
                [CDI:MAX_TARGET_NUMBER:A:1]
                [CDI:VERB:%s]
                [CDI:WAIT_PERIOD:%d]
]],
        hist_string, -- IS_HIST_STRING_2
        secret_name, -- IS_NAME
        config.ID_PREFIX, -- IT_CANNOT_HAVE... (e.g., ENHANCEAGILITY)
        level.syn_class, -- IT_CANNOT_HAVE... (e.g., PRIMARY)
        arena_name, -- IE_ARENA_NAME
        config.ID_PREFIX, level.syn_class, -- SYN_CLASSes
        interaction_id, -- CE:INTERACTION (self-referential for blood)
        ability_name, -- CDI:ADV_NAME
        config.PAYLOAD_PREFIX, level.token, -- CDI:INTERACTION (payload)
        -- MODIFIED: Removed config.ABILITY_BP_REQUIRED argument
        verb, -- CDI:VERB
        config.ABILITY_WAIT_PERIOD -- CDI:WAIT_PERIOD
    )
    
    table_merge(lines, split_to_lines({}, rest_of_raw))
    return lines
end

-- 4. Builds the Fortress Reaction (from reaction_craft_tablet_body.txt)
local function build_fortress_reaction(config, level, is_first)
    local lines = {}
    local reaction_id = string.format("%s_%s_PROGRAM", config.ID_PREFIX, level.token)
    local reaction_name = string.format("Body Enhancement- %s- %s", config.BUFF_NAME, level.name)
    local product = string.format("PRODUCT:100:1:MEAT:NONE:INORGANIC:%s_%s_PROGRAM", config.ID_PREFIX, level.token)
    local description = string.format("An edible tablet that grants an eligible life form an ability that enhances %s (%s).", config.BUFF_NOUN, level.name)
    
    -- === MODIFICATION START ===
    -- Conditionally build the reagent line
    local reagent_line = ""
    if not MAKE_REACTIONS_FREE_FOR_TESTING then
        local reagent = string.format("blank tablet:1:TOOL:%s%s:%s", config.FORT_REAGENT_PREFIX, level.reagent_suffix, config.FORT_REAGENT_MATERIAL)
        reagent_line = string.format("[REAGENT:%s]", reagent)
    end
    -- === MODIFICATION END ===

    table.insert(lines, string.format("[REACTION:%s]", reaction_id))
    add_generated_info(lines)
    
    -- === MODIFICATION START ===
    -- Use the conditional reagent_line string
    local rest_of_raw = string.format([[
    [NAME:%s]
    [FORTRESS_MODE_ENABLED][BUILDING:%s:NONE]
    %s
    [%s]
    [SKILL:EXTRACT_STRAND]
    [DESCRIPTION:%s]
    [CATEGORY:%s]
]],
        reaction_name,
        config.FORT_BUILDING,
        reagent_line, -- This will be empty if the flag is true
        product,
        description,
        config.FORT_CATEGORY_ID
    )
    -- === MODIFICATION END ===
    
    table_merge(lines, split_to_lines({}, rest_of_raw))
    
    -- Add category headers only for the first item in the list
    if is_first then
        table.insert(lines, string.format("    [CATEGORY_NAME:%s]", config.FORT_CATEGORY_NAME))
        table.insert(lines, string.format("    [CATEGORY_DESCRIPTION:%s]", config.FORT_CATEGORY_DESC))
    end
    
    return lines
end

-- 5. Builds the Adventure Reaction (from reaction_adv_crafting_advanced_attribute.txt)
local function build_adventure_reaction(config, level, is_first)
    local lines = {}
    local reaction_id = string.format("%s_%s_PROGRAM_ADV", config.ID_PREFIX, level.token)
    local reaction_name = string.format("Body Enhancement- %s- %s", config.BUFF_NAME, level.name)
    local product = string.format("PRODUCT:100:1:MEAT:NONE:INORGANIC:%s_%s_PROGRAM", config.ID_PREFIX, level.token)
    local description = string.format("An edible tablet that grants an eligible life form an ability that enhances %s (%s).", config.BUFF_NOUN, level.name)

    -- === MODIFICATION START ===
    -- Conditionally build the reagent lines
    local reagent_scrap_line = ""
    local reagent_tool_line = ""
    if not MAKE_REACTIONS_FREE_FOR_TESTING then
        local scrap_cost = config.ADV_SCRAP_COSTS[level.key] or 10 -- Default cost
        local reagent_scrap = string.format("scrap:%d:TOOL:%s:%s", scrap_cost, config.ADV_REAGENT_SCRAP, config.ADV_REAGENT_MATERIAL)
        local reagent_tool = string.format("tool:1:TOOL:%s:NONE:NONE][PRESERVE_REAGENT]", config.ADV_REAGENT_TOOL)
        
        reagent_scrap_line = string.format("[REAGENT:%s]", reagent_scrap)
        reagent_tool_line = string.format("[REAGENT:%s]", reagent_tool)
    end
    -- === MODIFICATION END ===

    table.insert(lines, string.format("[REACTION:%s]", reaction_id))
    add_generated_info(lines)

    -- === MODIFICATION START ===
    -- Use the conditional reagent_line strings
    local rest_of_raw = string.format([[
    [NAME:%s]
    [ADVENTURE_MODE_ENABLED]
    %s
    %s
    [%s]
    [SKILL:EXTRACT_STRAND]
    [DESCRIPTION:%s]
    [CATEGORY:%s]
]],
        reaction_name,
        reagent_scrap_line, -- Will be empty if flag is true
        reagent_tool_line,  -- Will be empty if flag is true
        product,
        description,
        config.ADV_CATEGORY_ID
    )
    -- === MODIFICATION END ===
    
    table_merge(lines, split_to_lines({}, rest_of_raw))
    
    if is_first then
        table.insert(lines, string.format("    [CATEGORY_NAME:%s]", config.ADV_CATEGORY_NAME))
        table.insert(lines, string.format("    [CATEGORY_DESCRIPTION:%s]", config.ADV_CATEGORY_DESC))
    end
    
    return lines
end

-- =============================================================================
-- ### MAIN GENERATOR FUNCTIONS ###
-- =============================================================================

-- System Generator for one buff type (e.g., Agility)
local function GenerateStatSystem(config)
    log("Generating buff system: " .. config.BUFF_NAME)
    
    local interaction_raws = {}
    local inorganic_raws = {}
    local reaction_raws = {}
    
    -- Loop through Primary, Secondary, etc. defined in LEVEL_MAP
    for i, level_data in ipairs(LEVEL_MAP) do
        local is_first_in_list = (i == 1)
        
        -- 1. Build Payload Interaction (e.g., AGILITYENHANCE_PRIMARY)
        table_merge(interaction_raws, build_payload_interaction(config, level_data))
        
        -- 2. Build Secret Interaction (e.g., ENHANCEAGILITY_PRIMARY_SECRET)
        table_merge(interaction_raws, build_secret_interaction(config, level_data))
        
        -- 3. Build Inorganic Tablet (e.g., ENHANCEAGILITY_PRIMARY_PROGRAM)
        table_merge(inorganic_raws, build_inorganic_tablet(config, level_data))
        
        -- 4. Build Fortress Reaction
        table_merge(reaction_raws, build_fortress_reaction(config, level_data, is_first_in_list))
        
        -- 5. Build Adventure Reaction
        table_merge(reaction_raws, build_adventure_reaction(config, level_data, is_first_in_list))
    end
    
    return interaction_raws, inorganic_raws, reaction_raws
end

-- =============================================================================
-- This is the main function your init.lua will call.
-- It expects a table of loaded config files.
-- =============================================================================
function buffs.generate_all_custom_buff_systems(loaded_configs)
    log("--- Generating All Custom Stat Systems (Attribute Module) ---")

    -- === MODIFICATION ===
    if MAKE_REACTIONS_FREE_FOR_TESTING then
        log("WARNING: MAKE_REACTIONS_FREE_FOR_TESTING is TRUE. All attribute reactions will be free.")
    end

    -- Initialize raw file containers
    local all_interaction_raws = {"[OBJECT:INTERACTION]"}
    local all_inorganic_raws = {"[OBJECT:INORGANIC]"}
    local all_reaction_raws = {"[OBJECT:REACTION]"}

    -- Iterate over the configs passed in from init.lua
    for _, config in ipairs(loaded_configs) do
        if config then
            log("Generating system from config: " .. (config.BUFF_NAME or "UNKNOWN"))
            
            local interactions, inorganics, reactions = GenerateStatSystem(config)
            
            -- Add the generated raws to the master lists
            table_merge(all_interaction_raws, interactions)
            table_merge(all_inorganic_raws, inorganics)
            table_merge(all_reaction_raws, reactions)
        else
            log("ERROR: A buff config was nil. Skipping.")
        end
    end

    -- Register all generated raws with the game in one batch
    raws.register_interactions(all_interaction_raws)
    raws.register_inorganics(all_inorganic_raws)
    raws.register_reactions(all_reaction_raws)
    
    log("--- Custom Attribute System Generation (Attribute Module) COMPLETE ---")
end

-- Return the module table
return buffs